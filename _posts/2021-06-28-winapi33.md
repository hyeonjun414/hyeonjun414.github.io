---
title: "WinAPI : 충돌3"
excerpt: "픽셀 충돌과 중력 적용"
toc: true
toc_sticky: true
toc_label: "목차"
categories:
  - WinAPI
tags:
  - [CPP, WinAPI]
date: 2021-06-28
breadcrumb: true
---

# 33강. 픽셀충돌체와 중력

## 프레임 계산

```csharp
m_fFPSTime += m_fDeltaTime;
++m_iFrame; //실행 횟수 만큼 프레임 증가

if (m_fFPSTime >= 1.f) // 1초가 지나면
{
	m_fFPS = m_iFrame / m_fFPSTime; // 프레임을 1초로 나눔
	// 다시 초기화
  m_fFPSTime = 0.f;
	m_iFrame = 0;
}
```

### 디버깅 용 콘솔창

현재 실행되는 환경에 따라 디버그용 환경을 출력하게 된다. 

```csharp
//코어 생성자
#ifdef _DEBUG
// 콘솔창을 생성하는 함수.
    AllocConsole();
#endif // _DEBUG

//코어 소멸자
#ifdef _DEBUG
    // 콘솔창을 해제하는 함수
    FreeConsole();
#endif // _DEBUG
```

### 콘솔창에 프레임 출력

_cprintf를 사용하기 위해서 Game헤더에 conio.h를 추가해야한다.

```csharp
if (m_fFPSTime >= 1.f)
	{
		m_fFPS = m_iFrame / m_fFPSTime;
		m_fFPSTime = 0.f;
		m_iFrame = 0;

#ifdef _DEBUG
		char strFPS[64] = {};
		sprintf_s(strFPS, "FPS : %.f\n", m_fFPS);
		//_cprintf(strFPS); //콘솔에 출력
		SetWindowTextA(m_hWnd, strFPS); //타이틀바에 출력
		OutputDebugStringA(strFPS); //비주얼 스튜디오 출력창에 출력
#endif // _DEBUG
	}
```

### 결과

![/assets/images/posts/2021-06-28/winapi33/Untitled.png](/assets/images/posts/2021-06-28/winapi33/Untitled.png)

이런식으로 사용할 수 있다.

## 중력과 픽셀 충돌 사전 작업

픽셀 충돌을 위해서는 이미지 픽셀 한칸한칸에 대한 모든 정보를 알아야한다. 픽셀 충돌과 중력을 적용하기에 앞서서 배경이미지를 알맞게 조정해주자.

![/assets/images/posts/2021-06-28/winapi33/Untitled%201.png](/assets/images/posts/2021-06-28/winapi33/Untitled%201.png)

밑쪽은 마젠타 색을 플레이어가 밟을 땅과 같은 역할을 해준다.

## 비트맵 구조

이미지의 픽셀 정보를 가져오려면 버퍼의 형태로 뽑아와야한다. 그렇게 하기 위해서는 픽셀 충돌체를 만들어준다음 fopen을 이용해 비트맵 형태로 열어준다. 열린 파일을 건들기 위해 비트맵의 기본 구조를 알아야한다.

bmp 파일은 크게 3가지로 구성된다.

1. FileHeader
2. InfoHeader
3. Pixel

win32에는 1번과 2번을 구조체 형태로 지원해준다. bmp는 압축 파일이 아니다. 그렇기 때문에 가져온 정보를 바탕으로 다른 절차 없이 바로 사용할 수 있다. 

## 중력 적용

오브젝트에 bool변수를 하나 둬서 물리 작용을 할지 결정한다. 그리고 중력을 적용받는 시간도 변수로 만든다.

```csharp
//obj 헤더
protected:
	bool m_bIsPhysics;
float	m_fGravityTime;

public:
	void SetPhysics(bool bPhysics)
	{
		m_bIsPhysics = bPhysics;
	}
	bool GetPhysics() const
	{
		return m_bIsPhysics;
	}
```

```csharp
//플레이어에 적용
SetPhysics(true); // 중력을 적용한다.
```

제대로 하려면 질량까지 적용해야하지만 일단 약식으로 한다.

```csharp
//Game 헤더
#define GRAVITY 0.98f // 기존은 9.8은 너무 큰 값이다.
```

업데이트에서 물리 효과가 적용되는 오브젝트는 따로 처리를 해주어야한다.

```csharp
if (m_bIsPhysics)
	{
		m_fGravityTime += fDeltaTime; // 중력적용 시간누적
		m_tPos.y += (GRAVITY * m_fGravityTime * m_fGravityTime); 
		// 시간이 커짐에 따라 오브젝트는 아래로 가속하면서 떨어짐
		// 제곱 처리를 안해주면 빨라지는 속도가 너무 느림.
	}
```

## 픽셀 충돌

픽셀 충돌은 픽셀 충돌체를 만들고 스테이지에 줌으로써 오브젝트와 충돌 처리를 하는 방식이다.

### 픽셀 충돌체

기본적으로 구 충돌체와 사각 충돌체처럼 기본적인 클래스 구성을 해준다.

다른 충돌체와 다르게 픽셀 충돌체는 Set을 비트맵 파일로 해줘야한다. 해당 스테이지 자체에 적용되기 때문이다.

픽셀에 대한 정보를 저장하기위해 구조체와 배열을 지정해준다.

```csharp
// 픽셀 구조체
typedef struct _tagPixel
{
	unsigned char r;
	unsigned char g;
	unsigned char b;

}PIXEL, *PPIXEL;

// 픽셀 값을 저장할 배열
private:
	vector<PIXEL> m_vecPixel;
```