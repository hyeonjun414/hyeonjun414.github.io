---
title: "WinAPI : 충돌2"
excerpt: "총알의 충돌 ~ 구형 충돌체"
toc: true
toc_sticky: true
toc_label: "목차"
categories:
  - WinAPI
tags:
  - [CPP, WinAPI]
date: 2021-06-23
breadcrumb: true
---

# 31강. 총알의 충돌 ~ 구형 충돌체

## 총알의 충돌함수 등록과 충돌 확인

총알은 원형이다. 지금은 사각 충돌체를 사용하고 있지만 구형으로 충돌작용이 이루어져야한다.

총알에 미니언에 만들어줬던 것과 비슷하게 Hit함수를 만들어 주자. 그리고 플레이어에서 발사할때 충돌체를 뽑아올 수 있도록 해야한다. 오브젝트 클래스에 충돌함수 등록기능을 추가한다.

```csharp
//Obj.h에 충돌체 헤더 추가
#include "../Collider/Collider.h"

//입력된 태그에 따라 일치하는 충돌을 등록하는 함수
template<typename T>
	void AddCollisionFunction(const string& strTag, COLLISION_STATE eState, T* pObj,
		void(T::* pFunc)(Collider*, Collider*, float))
	{
		list<Collider*>::iterator iter;
		list<Collider*>::iterator iterEnd = m_ColliderList.end();

		for (iter = m_ColliderList.begin(); iter != iterEnd; ++iter)
		{
			if ((*iter)->GetTag() == strTag)
			{
				(*iter)->AddCollisionFunction(eSate, pObj, pFunc);
				break;
			}
		}
	}
```

```csharp
//플레이어의 총알 발사 부분
void Player::Fire()
{
	Obj* pBullet = Obj::CreateCloneObj("Bullet", "PlayerBullet", m_pLayer);

	//발사하는 총알에 충돌함수를 추가한다.
	pBullet->AddCollisionFunction("Bullet", CS_LEAVE, (Bullet*)pBullet, &Bullet::Hit);

	POSITION tPos;
	tPos.x = GetRight() + pBullet->GetSize().x * pBullet->GetPivot().x;
	tPos.y = GetCenter().y;

	pBullet->SetPos(tPos);

	SAFE_RELEASE(pBullet);

}
```

Ref 클래스에 멤버번수로 태그를 추가하고 관련 함수를 만들어준다. 그리고 충돌체를 추가할 때 태그도 설정하도록 한다.

```csharp
string GetTag() const
{
		return m_strTag;
}
void SetTag(const string& strTag)
{
		m_strTag = strTag;
}

//충돌체 추가시 태그 설정
template <typename T>
	T* AddCollider(const string& strTag)
	{
		T* pCollider = new T;

		pCollider->SetObj(this);
		pCollider->SetTag(strTag);
...
...
```

### Hit 함수(총알의 충돌처리)

이제 충돌시 발생한 이벤트에 대해 확인을 해야한다. 상대방에 충돌한 총알은 없어져야한다.

```csharp
void Bullet::Hit(Collider* pSrc, Collider* pDest, float fDeltaTime)
{
	if (pDest->GetTag() == "Minion")
	{
		Die();
	}
}
```

충돌한 대상의 태그를 확인하고 만약 미니언이라면 총알이 사라지게 하였다. 오브젝트를 삭제하는 것으로 충돌체도 모두 삭제하여 처리하는 방식이다.

![/assets/images/posts/2021-06-23/winapi31/winapi31_1.gif](/assets/images/posts/2021-06-23/winapi31/winapi31_1.gif)

총알이 정상적으로 사라지는 것을 볼 수 있었다.

## 구 충돌체

사각 충돌체와 비슷하게 구 충돌체의 클래스도 비슷하게 정의해줄 수 있다. 그 이전에 Type에 구의 정보를 가지는 구조체를 만들어 줘야한다.

```csharp
typedef struct _tagSphere
{
	POSITION tCenter;
	float fRadius;

	_tagSphere() :
		tCenter(0.f, 0.f),
		fRadius(0.f)
	{}
}SPHERE, *PSPHERE;
```

이후 만들어준 ColliderSphere라는 구 충돌체 클래스를 만들어 사각 충돌체와 똑같이 설정을 해준다. 전반적인 코드는 비슷하다. 충돌 함수 부분에 구 관련 충돌함수를 추가해줘야하는 부분이 조금 다르다.

구형의 충돌체를 추가하기 때문에 구vs구, 구vs사각형의 충돌처리도 해줘야한다.

```csharp
bool CollisionRectToRect(const RECTANGLE& src, const RECTANGLE& dest);
bool CollisionRectToSphere(const RECTANGLE& src, const SPHERE& dest);
bool CollisionSphereToSphere(const SPHERE& src, const SPHERE& dest);
```

```csharp
bool Collider::CollisionSphereToSphere(const SPHERE& src, const SPHERE& dest)
{
	Math* math;
	float fDist = math->Distance(src.tCenter, dest.tCenter);

	return fDist <= src.fRadius + dest.fRadius;
}
```

## 수학관련함수

### 두점의 거리

```csharp
float Math::GetDistance(const POSITION& tPos1, const POSITION& tPos2)
{
	float x, y;

	x = tPos2.x - tPos1.x;
	y = tPos2.y - tPos1.y;

	return sqrtf(x * x + y * y);
}
```